#!/bin/bash

BASE64_PY="aW1wb3J0IHlhbWwKaW1wb3J0IHN5cwoKCmRlZiBoYXNfZGljdF9rZXlzKGQsIGtleXMpOgogICAgaWYgaXNpbnN0YW5jZShrZXlzLCBsaXN0KToKICAgICAgICBmb3IgXyBpbiBrZXlzOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkID0gZFtfXQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgIGVsc2U6CiAgICAgICAgaWYga2V5cyBpbiBkLmtleXMoKToKICAgICAgICAgICAgcmV0dXJuIFRydWUsIGRba2V5c10KICAgICAgICByZXR1cm4gRmFsc2UKCgpkZWYgc2V0X25lc3RlZChkLCBrLCB2KToKICAgIGlmIGxlbihrKSA8PSAxOgogICAgICAgIGRba1swXV0gPSB2CiAgICBlbHNlOgogICAgICAgIG9rID0ga1swXQogICAgICAgIGsgPSBrWzE6XQogICAgICAgIHNldF9uZXN0ZWQoZFtva10sIGssIHYpCgoKZGVmIHJlYWRfYW5kX21vZGlmeV9vbmVfYmxvY2tfb2ZfeWFtbF9kYXRhKGtleSwgZmlsdGVyX2J5LCBuZXdfZGF0YSk6CiAgICBmID0gc3lzLnN0ZGluLnJlYWQoKQogICAgZGF0YSA9IHlhbWwuc2FmZV9sb2FkX2FsbChmKQogICAgZGF0YV9hbGwgPSBbXQogICAgZm9yIGRvYyBpbiBkYXRhOgogICAgICAgIGRvY19kaWN0ID0gZG9jCiAgICAgICAgaWYgaGFzX2RpY3Rfa2V5cyhkb2NfZGljdCwga2V5KToKICAgICAgICAgICAgZG9jXyA9IGRvY19kaWN0CiAgICAgICAgICAgIGZvciBrIGluIGtleToKICAgICAgICAgICAgICAgIGRvY18gPSBkb2NfW2tdCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZG9jXywgbGlzdCk6CiAgICAgICAgICAgICAgICBkb2NfID0gZG9jX1swXQogICAgICAgICAgICBpZiBmaWx0ZXJfYnlbJ2tleSddIGluIGRvY18ua2V5cygpIGFuZCBkb2NfW2ZpbHRlcl9ieVsna2V5J11dID09IGZpbHRlcl9ieVsndmFsdWUnXToKICAgICAgICAgICAgICAgIGRvY18gPSB7Kipkb2NfLCAqKm5ld19kYXRhfQogICAgICAgICAgICBzZXRfbmVzdGVkKGRvY19kaWN0LCBrZXksIGRvY18pCiAgICAgICAgZGF0YV9hbGwuYXBwZW5kKGRvY19kaWN0KQogICAgcmV0dXJuIHlhbWwuZHVtcF9hbGwoZGF0YV9hbGwpCgoKciA9IHJlYWRfYW5kX21vZGlmeV9vbmVfYmxvY2tfb2ZfeWFtbF9kYXRhKGtleT1bJ3NwZWMnLCAndGVtcGxhdGUnLCAnc3BlYycsICdjb250YWluZXJzJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJfYnk9eydrZXknOiAnbmFtZScsICd2YWx1ZSc6ICdjaGVja292J30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdfZGF0YT17J3Jlc291cmNlcyc6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAncmVxdWVzdHMnOiB7J21lbW9yeSc6ICc1MTJNaSd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsaW1pdHMnOiB7J21lbW9yeSc6ICcxMDI0TWknfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKcHJpbnQocikK"
python -c "import base64;exec(base64.b64decode('$BASE64_PY'))"